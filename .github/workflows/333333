name: å…¨å¹³å°è‡ªåŠ¨ç¼–è¯‘ (All in One)

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
   # ä»»åŠ¡1: ç¼–è¯‘ Android APK (æœ€ç»ˆä¿®æ­£ç‰ˆ)
  build-android:
    name: ğŸ“± Android æ„å»º (å¼ºè¡Œé€šè¿‡ç‰ˆ)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17' # ç°åœ¨çš„ Flutter é¡¹ç›®é€šå¸¸éœ€è¦ Java 17
          
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: ä¸‹è½½ä¾èµ–
        working-directory: ./simple_live_app
        run: flutter pub get

      - name: æš´åŠ›ä¿®æ”¹ç­¾åé…ç½®
        working-directory: ./simple_live_app/android/app
        run: |
          # 1. åˆ›å»ºä¸€ä¸ªç©ºçš„ key.properties éª—è¿‡æ–‡ä»¶æ£€æŸ¥
          touch ../key.properties
          
          # 2. ä½¿ç”¨ sed å‘½ä»¤ä¿®æ”¹ build.gradle
          # å°† "signingConfig signingConfigs.release" æ›¿æ¢ä¸º "signingConfig signingConfigs.debug"
          # æ„æ€æ˜¯ï¼šä½ è¦æ­£å¼ç­¾åï¼Ÿä¸ï¼Œæˆ‘å°±ç»™ä½ æµ‹è¯•ç­¾åï¼
          sed -i 's/signingConfig signingConfigs.release/signingConfig signingConfigs.debug/g' build.gradle
          
          # 3. é˜²æ­¢æŸäº›é¡¹ç›®æ²¡æœ‰å®šä¹‰ release ç­¾åå¯¼è‡´æ›¿æ¢å¤±è´¥ï¼Œ
          # æˆ‘ä»¬æŠŠ release { ... } é‡Œçš„é…ç½®æ‰“å°å‡ºæ¥çœ‹çœ‹ï¼ˆè°ƒè¯•ç”¨ï¼‰ï¼Œ
          # å¹¶ä¸”å°è¯•æŠŠ minifyEnabled true æ”¹ä¸º false é˜²æ­¢æ··æ·†æŠ¥é”™
          sed -i 's/minifyEnabled true/minifyEnabled false/g' build.gradle
          sed -i 's/shrinkResources true/shrinkResources false/g' build.gradle

      - name: å¼€å§‹ç¼–è¯‘ APK
        working-directory: ./simple_live_app
        # å¢åŠ å‚æ•°ï¼š
        # --debug: ä½¿ç”¨ debug ç­¾å (åŒé‡ä¿é™©)
        # --no-shrink: ç¦ç”¨ä»£ç å‹ç¼©ï¼Œé˜²æ­¢ R8 æŠ¥é”™ (Exit code 1 çš„å¸¸è§åŸå› )
        run: flutter build apk --release --no-shrink

      - name: ä¸Šä¼  Android äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SimpleLive-Android
          path: ./simple_live_app/build/app/outputs/flutter-apk/app-release.apk

  # ä»»åŠ¡2: ç¼–è¯‘ Windows EXE
  build-windows:
    name: ğŸ’» Windows æ„å»º
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: å¼€å¯ Windows æ”¯æŒ
        run: flutter config --enable-windows-desktop
      - name: ä¸‹è½½ä¾èµ–
        working-directory: ./simple_live_app
        run: flutter pub get
      - name: å¼€å§‹ç¼–è¯‘ Windows
        working-directory: ./simple_live_app
        run: flutter build windows --release
      - name: æ‰“åŒ…æˆ Zip
        run: |
          cd simple_live_app/build/windows/x64/runner/Release
          7z a SimpleLive-Windows.zip .
        shell: bash
      - name: ä¸Šä¼  Windows äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SimpleLive-Windows
          path: simple_live_app/build/windows/x64/runner/Release/SimpleLive-Windows.zip

  # ä»»åŠ¡3: ç¼–è¯‘ iOS IPA (TrollStore ä¸“ç”¨)
  build-ios:
    name: ğŸ iOS æ„å»º (æ— ç­¾å)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      - name: ä¸‹è½½ä¾èµ–
        working-directory: ./simple_live_app
        run: flutter pub get
      - name: å®‰è£… iOS ä¾èµ– (Pod)
        working-directory: ./simple_live_app/ios
        run: pod install --repo-update
      - name: å¼€å§‹ç¼–è¯‘ (è·³è¿‡ç­¾å)
        working-directory: ./simple_live_app
        # å…³é”®å‚æ•° --no-codesignï¼Œç”ŸæˆæœªåŠ å¯†çš„äºŒè¿›åˆ¶æ–‡ä»¶
        run: flutter build ios --release --no-codesign
      - name: æ‰“åŒ…æˆ IPA
        working-directory: ./simple_live_app
        run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r SimpleLive-TrollStore.ipa Payload
      - name: ä¸Šä¼  iOS äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SimpleLive-iOS-TrollStore
          path: ./simple_live_app/SimpleLive-TrollStore.ipa
