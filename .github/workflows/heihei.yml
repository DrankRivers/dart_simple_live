name: å…¨å¹³å°è‡ªåŠ¨ç¼–è¯‘ (All in One)

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
  # ä»»åŠ¡1: ç¼–è¯‘ Android APK
  build-android:
    name: ğŸ“± Android æ„å»º
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: ä¸‹è½½ä¾èµ–
        working-directory: ./simple_live_app
        run: flutter pub get
      - name: å¼€å§‹ç¼–è¯‘ APK
        working-directory: ./simple_live_app
        run: flutter build apk --release 
      - name: ä¸Šä¼  Android äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SimpleLive-Android
          path: ./simple_live_app/build/app/outputs/flutter-apk/app-release.apk

  # ä»»åŠ¡2: ç¼–è¯‘ Windows EXE
  build-windows:
    name: ğŸ’» Windows æ„å»º
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: å¼€å¯ Windows æ”¯æŒ
        run: flutter config --enable-windows-desktop
      - name: ä¸‹è½½ä¾èµ–
        working-directory: ./simple_live_app
        run: flutter pub get
      - name: å¼€å§‹ç¼–è¯‘ Windows
        working-directory: ./simple_live_app
        run: flutter build windows --release
      - name: æ‰“åŒ…æˆ Zip
        run: |
          cd simple_live_app/build/windows/x64/runner/Release
          7z a SimpleLive-Windows.zip .
        shell: bash
      - name: ä¸Šä¼  Windows äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SimpleLive-Windows
          path: simple_live_app/build/windows/x64/runner/Release/SimpleLive-Windows.zip

  # ä»»åŠ¡3: ç¼–è¯‘ iOS IPA (TrollStore ä¸“ç”¨)
  build-ios:
    name: ğŸ iOS æ„å»º (æ— ç­¾å)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      - name: ä¸‹è½½ä¾èµ–
        working-directory: ./simple_live_app
        run: flutter pub get
      - name: å®‰è£… iOS ä¾èµ– (Pod)
        working-directory: ./simple_live_app/ios
        run: pod install --repo-update
      - name: å¼€å§‹ç¼–è¯‘ (è·³è¿‡ç­¾å)
        working-directory: ./simple_live_app
        # å…³é”®å‚æ•° --no-codesignï¼Œç”ŸæˆæœªåŠ å¯†çš„äºŒè¿›åˆ¶æ–‡ä»¶
        run: flutter build ios --release --no-codesign
      - name: æ‰“åŒ…æˆ IPA
        working-directory: ./simple_live_app
        run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r SimpleLive-TrollStore.ipa Payload
      - name: ä¸Šä¼  iOS äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SimpleLive-iOS-TrollStore
          path: ./simple_live_app/SimpleLive-TrollStore.ipa
